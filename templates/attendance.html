<!-- attendance.html -->
{% extends 'layout.html' %}

{% block title %}考勤管理{% endblock %}

{% block content %}
<h1 class="mb-4">考勤管理</h1>

<h5 class="mb-3 text-muted">考勤状况</h5>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <form method="GET" class="d-flex gap-2">
            <input type="date" name="start_date" value="{{ request.args.get('start_date', '') }}" class="form-control" placeholder="开始日期">
            <input type="date" name="end_date" value="{{ request.args.get('end_date', '') }}" class="form-control" placeholder="结束日期">
            {% if session.get('role') in ['admin', 'teacher'] %}
            <input type="hidden" name="hide_processed" value="{{ '1' if hide_processed else '0' }}">
            {% endif %}
            <button type="submit" class="btn btn-secondary">筛选</button>
        </form>
    </div>
    {% if session.get('role') in ['admin', 'teacher'] %}
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAttendanceModal">
        <i class="bi bi-plus-circle"></i> 添加考勤记录
    </button>
    {% endif %}
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>学生姓名</th>
                <th>学号</th>
                <th>日期</th>
                <th>状态</th>
                <th>原因</th>
                {% if session.get('role') in ['admin', 'teacher'] %}
                <th>操作</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for record in attendance_records %}
            <tr>
                <td>{{ record.student_name }}</td>
                <td>{{ record.student_id_str }}</td>
                <td>{{ record.date }}</td>
                <td>
                    {% if record.status == 'present' %}
                        <span class="badge bg-success">出勤</span>
                    {% elif record.status == 'absent' %}
                        <span class="badge bg-danger">缺勤</span>
                    {% elif record.status == 'leave' %}
                        <span class="badge bg-warning text-dark">请假</span>
                    {% endif %}
                </td>
                <td>{{ record.reason or 'N/A' }}</td>
                {% if session.get('role') in ['admin', 'teacher'] %}
                <td>
                    <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editAttendanceModal{{ record.id }}">
                        <i class="bi bi-pencil"></i> 编辑
                    </button>
                    <form action="{{ url_for('delete_attendance', id=record.id) }}" method="POST" class="d-inline delete-form">
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('确定要删除这条考勤记录吗？')">
                            <i class="bi bi-trash"></i> 删除
                        </button>
                    </form>
                </td>
                {% endif %}
            </tr>
            {% else %}
            <tr>
                <td colspan="{% if session.get('role') in ['admin', 'teacher'] %}6{% else %}5{% endif %}" class="text-center text-muted">暂无考勤记录。</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if session.get('role') in ['admin', 'teacher'] %}
<div class="mt-5">
    <h5 class="mb-3 text-muted">请假审批</h5>
    <div class="card">
        <div class="card-body p-0">
            <div class="p-3 border-bottom d-flex align-items-center justify-content-between">
                <div>
                    <label class="form-check-label small text-muted" for="hideProcessedToggle">仅显示待审批</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="hideProcessedToggle" {% if hide_processed %}checked{% endif %}
                        onchange="toggleHideProcessed(this)">
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>学生</th>
                            <th>学号</th>
                            <th>起始日期</th>
                            <th>结束日期</th>
                            <th>原因</th>
                            <th>状态</th>
                            <th>审批人</th>
                            <th class="text-end">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for leave in leaves %}
                        <tr>
                            <td>{{ leave.student_name or '未知' }}</td>
                            <td>{{ leave.student_id_str or '-' }}</td>
                            <td>{{ leave.start_date }}</td>
                            <td>{{ leave.end_date }}</td>
                            <td style="max-width:320px; white-space: pre-wrap;">{{ leave.reason }}</td>
                            <td>
                                {% if leave.status == 'approved' %}
                                    <span class="badge bg-success">已批准</span>
                                {% elif leave.status == 'rejected' %}
                                    <span class="badge bg-danger">已驳回</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">待审批</span>
                                {% endif %}
                            </td>
                            <td>{{ leave.approver_name or '-' }}</td>
                            <td class="text-end">
                                {% if leave.status == 'pending' %}
                                <form method="POST" action="{{ url_for('review_leave', leave_id=leave.id) }}" class="d-inline">
                                    <input type="hidden" name="decision" value="approved">
                                    <button type="submit" class="btn btn-sm btn-success">批准</button>
                                </form>
                                <form method="POST" action="{{ url_for('review_leave', leave_id=leave.id) }}" class="d-inline ms-1">
                                    <input type="hidden" name="decision" value="rejected">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">驳回</button>
                                </form>
                                <form method="POST" action="{{ url_for('delete_leave', leave_id=leave.id) }}" class="d-inline ms-1" onsubmit="return confirm('确定删除该请假吗？相关请假考勤将一并删除');">
                                    <button type="submit" class="btn btn-sm btn-outline-secondary">删除</button>
                                </form>
                                {% else %}
                                <span class="text-muted">已处理</span>
                                <form method="POST" action="{{ url_for('delete_leave', leave_id=leave.id) }}" class="d-inline ms-2" onsubmit="return confirm('确定删除该请假吗？相关请假考勤将一并删除');">
                                    <button type="submit" class="btn btn-sm btn-outline-secondary">删除</button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">暂无请假申请。</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 添加考勤记录的模态框 -->
{% if session.get('role') in ['admin', 'teacher'] %}
<div class="modal fade" id="addAttendanceModal" tabindex="-1" aria-labelledby="addAttendanceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAttendanceModalLabel">添加考勤记录</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('add_attendance') }}">
                <div class="modal-body">
                    <input type="hidden" name="referrer" value="{{ request.url }}">
                    
                    <div class="mb-3">
                        <label for="student_id" class="form-label">选择学生 <span class="text-danger">*</span></label>
                        <select class="form-select" id="student_id" name="student_id" required>
                            <option value="" selected disabled>请选择学生</option>
                            {% for student in students %}
                            <option value="{{ student.id }}">{{ student.name }} ({{ student.student_id }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="date" class="form-label">日期 <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="date" name="date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="status" class="form-label">考勤状态 <span class="text-danger">*</span></label>
                        <select class="form-select" id="status" name="status" required>
                            <option value="present" selected>出勤</option>
                            <option value="absent">缺勤</option>
                            <option value="leave">请假</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="reason" class="form-label">原因说明</label>
                        <textarea class="form-control" id="reason" name="reason" rows="3" placeholder="请输入原因说明（可选）"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">添加</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- 为每个考勤记录创建编辑模态框 -->
{% for record in attendance_records %}
<div class="modal fade" id="editAttendanceModal{{ record.id }}" tabindex="-1" aria-labelledby="editAttendanceModalLabel{{ record.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAttendanceModalLabel{{ record.id }}">编辑考勤记录</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('edit_attendance', id=record.id) }}">
                <div class="modal-body">
                    <input type="hidden" name="referrer" value="{{ request.url }}">
                    
                    <div class="mb-3">
                        <label class="form-label">学生姓名</label>
                        <input type="text" class="form-control" value="{{ record.student_name }}" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">学号</label>
                        <input type="text" class="form-control" value="{{ record.student_id_str }}" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">日期</label>
                        <input type="text" class="form-control" value="{{ record.date }}" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="status{{ record.id }}" class="form-label">考勤状态 <span class="text-danger">*</span></label>
                        <select class="form-select" id="status{{ record.id }}" name="status" required>
                            <option value="present" {% if record.status == 'present' %}selected{% endif %}>出勤</option>
                            <option value="absent" {% if record.status == 'absent' %}selected{% endif %}>缺勤</option>
                            <option value="leave" {% if record.status == 'leave' %}selected{% endif %}>请假</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="reason{{ record.id }}" class="form-label">原因说明</label>
                        <textarea class="form-control" id="reason{{ record.id }}" name="reason" rows="3" placeholder="请输入原因说明">{{ record.reason or '' }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}

{% block extra_js %}
<script>
function toggleHideProcessed(el){
    const url = new URL(window.location.href);
    url.searchParams.set('hide_processed', el.checked ? '1' : '0');
    window.location = url.toString();
}
// 页面加载完成后的处理
document.addEventListener('DOMContentLoaded', function() {
    // 删除确认
    var deleteForms = document.querySelectorAll('.delete-form');
    deleteForms.forEach(function(form) {
        form.addEventListener('submit', function(e) {
            if (!confirm('确定要删除这条考勤记录吗？')) {
                e.preventDefault();
            }
        });
    });
    
    // 添加模态框显示后重置表单
    var addModal = document.getElementById('addAttendanceModal');
    if (addModal) {
        addModal.addEventListener('show.bs.modal', function() {
            // 设置默认日期为今天
            var today = new Date().toISOString().split('T')[0];
            var dateField = document.getElementById('date');
            if (dateField) {
                dateField.value = today;
            }
        });
        
        addModal.addEventListener('hidden.bs.modal', function() {
            // 重置表单
            var form = this.querySelector('form');
            form.reset();
            
            // 重新设置默认日期
            var today = new Date().toISOString().split('T')[0];
            var dateField = document.getElementById('date');
            if (dateField) {
                dateField.value = today;
            }
        });
    }
    
    // 状态选择变化时，自动显示/隐藏原因字段
    var statusSelects = document.querySelectorAll('select[name="status"]');
    statusSelects.forEach(function(select) {
        select.addEventListener('change', function() {
            var formGroup = this.closest('.modal-content');
            var reasonField = formGroup.querySelector('textarea[name="reason"]');
            
            if (this.value === 'present') {
                reasonField.placeholder = '请输入原因说明（可选）';
            } else {
                reasonField.placeholder = '请输入原因说明';
            }
        });
    });
    
    // 表单提交验证
    var forms = document.querySelectorAll('form[method="POST"]');
    forms.forEach(function(form) {
        form.addEventListener('submit', function(e) {
            // 检查必填字段
            var requiredFields = form.querySelectorAll('[required]');
            var isValid = true;
            
            requiredFields.forEach(function(field) {
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('is-invalid');
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                alert('请填写所有必填字段！');
            }
        });
    });
    
    // 实时验证必填字段
    var requiredFields = document.querySelectorAll('[required]');
    requiredFields.forEach(function(field) {
        field.addEventListener('input', function() {
            if (this.value.trim()) {
                this.classList.remove('is-invalid');
            }
        });
    });
});
</script>

<style>
.delete-form {
    display: inline-block;
    margin-left: 5px;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.modal-body .form-control:read-only {
    background-color: #f8f9fa;
    opacity: 1;
}

.badge {
    font-size: 0.75rem;
}

.text-danger {
    color: #dc3545 !important;
}

.is-invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.4.4.4-.4'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

/* 为模态框添加动画效果 */
.modal.fade .modal-dialog {
    transition: transform 0.3s ease-out;
}

/* 表格行悬停效果 */
.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.075);
}

/* 响应式调整 */
@media (max-width: 768px) {
    .d-flex {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .d-flex h4 {
        margin-bottom: 1rem;
    }
    
    .btn-sm {
        display: block;
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .delete-form {
        display: block;
        margin-left: 0;
    }
}
</style>
{% endblock %}