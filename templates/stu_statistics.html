{% extends "layout.html" %}

{% block title %}ä¸ªäººç»Ÿè®¡åˆ†æ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">ğŸ“ŠğŸ“Š ä¸ªäººå­¦ä¹ ç»Ÿè®¡åˆ†æ</h2>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ğŸ‘¤ğŸ‘¤ å­¦ç”ŸåŸºæœ¬ä¿¡æ¯</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>å§“å:</strong> {{ student.name }}
                    </div>
                    <div class="col-md-3">
                        <strong>å­¦å·:</strong> {{ student.student_id }}
                    </div>
                    <div class="col-md-3">
                        <strong>ç­çº§:</strong> {{ student.class_name }}
                    </div>
                    <div class="col-md-3">
                        <strong>ç­ä¸»ä»»:</strong> {{ student.homeroom_teacher }}
                    </div>
                </div>
            </div>
        </div>

        <!-- æˆç»©è¶‹åŠ¿åˆ†æ -->
        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">ğŸ“ˆğŸ“ˆ æˆç»©è¶‹åŠ¿åˆ†æ</h5>
                    </div>
                    <div class="card-body">
                        {% if grades_data and grades_data|length > 0 %}
                        <div class="mt-3">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>è¯¾ç¨‹åç§°</th>
                                        <th>è€ƒè¯•æˆç»©</th>
                                        <th>å¹³æ—¶æˆç»©</th>
                                        <th>æ€»è¯„æˆç»©</th>
                                        <th>ç­çº§å¹³å‡</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for grade in grades_data %}
                                    <tr>
                                        <td>{{ grade.course_name }}</td>
                                        <td class="{% if grade.exam_score >= 90 %}text-success{% elif grade.exam_score < 60 %}text-danger{% endif %}">
                                            {{ grade.exam_score if grade.exam_score is not none else 'N/A' }}
                                        </td>
                                        <td class="{% if grade.performance_score >= 90 %}text-success{% elif grade.performance_score is not none and grade.performance_score < 60 %}text-danger{% endif %}">
                                            {{ grade.performance_score if grade.performance_score is not none else 'N/A' }}
                                        </td>
                                        <td class="{% if grade.total_score >= 90 %}text-success{% elif grade.total_score < 60 %}text-danger{% endif %}">
                                            {{ "%.1f"|format(grade.total_score) if grade.total_score is not none else 'N/A' }}
                                        </td>
                                        <td>
                                            {% if grade.course_name in class_avg_scores and class_avg_scores[grade.course_name].avg_total is not none %}
                                            {{ "%.1f"|format(class_avg_scores[grade.course_name].avg_total) }}
                                            {% else %}
                                            N/A
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">æš‚æ— æˆç»©æ•°æ®</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- å­¦ä¹ æ•°æ®æ¦‚è§ˆ -->
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">ğŸ“‹ğŸ“‹ å­¦ä¹ æ•°æ®æ¦‚è§ˆ</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="card bg-light">
                                    <div class="card-body py-3">
                                        <h3 class="text-primary">{{ "%.1f"|format(attendance_rate) if attendance_rate is not none else 'N/A' }}%</h3>
                                        <small>å‡ºå‹¤ç‡</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="card bg-light">
                                    <div class="card-body py-3">
                                        <h3 class="text-success">{{ grades_data|length if grades_data else 0 }}</h3>
                                        <small>å·²ä¿®è¯¾ç¨‹</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-light">
                                    <div class="card-body py-3">
                                        <h3 class="text-warning">{{ rewards|length if rewards else 0 }}</h3>
                                        <small>å¥–åŠ±æ¬¡æ•°</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-light">
                                    <div class="card-body py-3">
                                        <h3 class="text-danger">{{ punishments|length if punishments else 0 }}</h3>
                                        <small>å¤„åˆ†æ¬¡æ•°</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <h6>å‡ºå‹¤æ˜ç»†</h6>
                            {% set total_attendance = (present_count|default(0)|int) + (absent_count|default(0)|int) + (leave_count|default(0)|int) %}
                            <div class="progress mb-2" style="height: 20px;">
                                <div class="progress-bar bg-success" style="width: {{ (present_count|default(0)|int / total_attendance * 100)|round(1) if total_attendance > 0 else 0 }}%">
                                    å‡ºå¸­: {{ present_count if present_count is not none else 0 }}
                                </div>
                                <div class="progress-bar bg-danger" style="width: {{ (absent_count|default(0)|int / total_attendance * 100)|round(1) if total_attendance > 0 else 0 }}%">
                                    ç¼ºå¸­: {{ absent_count if absent_count is not none else 0 }}
                                </div>
                                <div class="progress-bar bg-warning" style="width: {{ (leave_count|default(0)|int / total_attendance * 100)|round(1) if total_attendance > 0 else 0 }}%">
                                    è¯·å‡: {{ leave_count if leave_count is not none else 0 }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¯¹æ¯”åˆ†æå’Œå­¦ä¹ å»ºè®® -->
        <div class="row">
            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">ğŸ“ŠğŸ“Š æˆç»©å¯¹æ¯”åˆ†æ</h5>
                    </div>
                    <div class="card-body">
                        {% if grades_data and grades_data|length > 0 %}
                        <div class="mt-3">
                            <h6>ä¸ç­çº§å¹³å‡åˆ†å¯¹æ¯”</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>è¯¾ç¨‹</th>
                                            <th>æˆ‘çš„æˆç»©</th>
                                            <th>ç­çº§å¹³å‡</th>
                                            <th>å·®å¼‚</th>
                                            <th>æ°´å¹³</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for grade in grades_data %}
                                        {% if grade.course_name in class_avg_scores and class_avg_scores[grade.course_name].avg_total is not none and grade.total_score is not none %}
                                        <tr>
                                            <td>{{ grade.course_name }}</td>
                                            <td>{{ "%.1f"|format(grade.total_score) }}</td>
                                            <td>{{ "%.1f"|format(class_avg_scores[grade.course_name].avg_total) }}</td>
                                            <td class="{% if grade.total_score > class_avg_scores[grade.course_name].avg_total %}text-success{% elif grade.total_score < class_avg_scores[grade.course_name].avg_total %}text-danger{% endif %}">
                                                {{ "%+.1f"|format(grade.total_score - class_avg_scores[grade.course_name].avg_total) }}
                                            </td>
                                            <td>
                                                <span class="badge {% if grade.total_score > class_avg_scores[grade.course_name].avg_total + 10 %}bg-success{% elif grade.total_score < class_avg_scores[grade.course_name].avg_total - 10 %}bg-danger{% else %}bg-warning{% endif %}">
                                                    {% if grade.total_score > class_avg_scores[grade.course_name].avg_total + 10 %}
                                                    ä¼˜ç§€
                                                    {% elif grade.total_score < class_avg_scores[grade.course_name].avg_total - 10 %}
                                                    éœ€åŠªåŠ›
                                                    {% else %}
                                                    ä¸­ç­‰
                                                    {% endif %}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">æš‚æ— å¯¹æ¯”æ•°æ®</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header bg-purple text-white">
                        <h5 class="mb-0">ğŸ’¡ğŸ’¡ ä¸ªæ€§åŒ–å­¦ä¹ å»ºè®®</h5>
                    </div>
                    <div class="card-body">
                        <div class="study-recommendations">
                            {% if study_recommendations and study_recommendations|length > 0 %}
                                {% for recommendation in study_recommendations %}
                                <div class="alert alert-info alert-dismissible fade show" role="alert">
                                    {{ recommendation|safe }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="alert alert-info" role="alert">
                                    <h6>å­¦ä¹ å»ºè®®ï¼š</h6>
                                    <ul>
                                        <li>ä¿æŒè‰¯å¥½çš„ä½œæ¯æ—¶é—´ï¼Œç¡®ä¿å……è¶³ç¡çœ </li>
                                        <li>è¯¾å‰é¢„ä¹ ï¼Œè¯¾åå¤ä¹ ï¼Œå·©å›ºçŸ¥è¯†ç‚¹</li>
                                        <li>ç§¯æå‚ä¸è¯¾å ‚è®¨è®ºï¼Œæé«˜å­¦ä¹ æ•ˆç‡</li>
                                        <li>å®šæœŸæ€»ç»“å­¦ä¹ æˆæœï¼ŒæŸ¥æ¼è¡¥ç¼º</li>
                                        {% if attendance_rate is not none and attendance_rate < 80 %}
                                        <li class="text-danger">æ³¨æ„æé«˜å‡ºå‹¤ç‡ï¼ŒæŒ‰æ—¶ä¸Šè¯¾</li>
                                        {% endif %}
                                        {% if grades_data %}
                                            {% set weak_subjects = [] %}
                                            {% for grade in grades_data %}
                                                {% if grade.total_score is not none and grade.total_score < 60 %}
                                                    {% set _ = weak_subjects.append(grade.course_name) %}
                                                {% endif %}
                                            {% endfor %}
                                            {% if weak_subjects|length > 0 %}
                                            <li class="text-danger">é‡ç‚¹å…³æ³¨ä»¥ä¸‹ç§‘ç›®ï¼š{{ weak_subjects|join(', ') }}</li>
                                            {% endif %}
                                        {% endif %}
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mt-3">
                            <h6>æœ¬å‘¨å­¦ä¹ è®¡åˆ’</h6>
                            <ul class="list-group">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    æ¯æ—¥é¢„ä¹ ç¬¬äºŒå¤©è¯¾ç¨‹
                                    <span class="badge bg-primary rounded-pill">æ¯å¤©</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    å®Œæˆæ•°å­¦ä½œä¸šç»ƒä¹ 
                                    <span class="badge bg-success rounded-pill">å‘¨ä¸€ã€ä¸‰ã€äº”</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    è‹±è¯­å•è¯è®°å¿†
                                    <span class="badge bg-info rounded-pill">æ¯å¤©10ä¸ª</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    å‘¨å¤ä¹ æ€»ç»“
                                    <span class="badge bg-warning rounded-pill">å‘¨æ—¥</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸Šè¯¾æ—¶é—´åˆ†å¸ƒ -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">â°â°â° ä¸Šè¯¾æ—¶é—´åˆ†å¸ƒ</h5>
            </div>
            <div class="card-body">
                {% if schedule_distribution %}
                <div class="row">
                    {% for day, schedules in schedule_distribution.items() %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    {% if day == 'Monday' %}æ˜ŸæœŸä¸€
                                    {% elif day == 'Tuesday' %}æ˜ŸæœŸäºŒ
                                    {% elif day == 'Wednesday' %}æ˜ŸæœŸä¸‰
                                    {% elif day == 'Thursday' %}æ˜ŸæœŸå››
                                    {% elif day == 'Friday' %}æ˜ŸæœŸäº”
                                    {% elif day == 'Saturday' %}æ˜ŸæœŸå…­
                                    {% elif day == 'Sunday' %}æ˜ŸæœŸæ—¥
                                    {% else %}{{ day }}{% endif %}
                                </h6>
                            </div>
                            <div class="card-body">
                                {% if schedules and schedules|length > 0 %}
                                    {% for schedule in schedules %}
                                    <div class="mb-2 p-2 border rounded">
                                        <small class="text-muted">{{ schedule.start_time }} - {{ schedule.end_time }}</small>
                                        <div class="fw-bold">{{ schedule.course_name }}</div>
                                        <small class="text-muted">{{ schedule.location }}</small>
                                        {% if schedule.attendance_status %}
                                        <div>
                                            <span class="badge 
                                                {% if schedule.attendance_status == 'present' %}bg-success
                                                {% elif schedule.attendance_status == 'absent' %}bg-danger
                                                {% elif schedule.attendance_status == 'leave' %}bg-warning
                                                {% else %}bg-secondary{% endif %}">
                                                {% if schedule.attendance_status == 'present' %}å‡ºå‹¤
                                                {% elif schedule.attendance_status == 'absent' %}ç¼ºå‹¤
                                                {% elif schedule.attendance_status == 'leave' %}è¯·å‡
                                                {% else %}{{ schedule.attendance_status }}{% endif %}
                                            </span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted text-center">æ— è¯¾ç¨‹å®‰æ’</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <p class="text-muted">æš‚æ— æ’è¯¾æ•°æ®</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ç§»é™¤äº†æ‰€æœ‰å›¾è¡¨ç›¸å…³çš„JavaScriptä»£ç  -->
{% endblock %}