{% extends 'layout.html' %}

{% block title %}ç»Ÿè®¡åˆ†æ{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">ğŸ“ˆ ç»Ÿè®¡åˆ†æä¸è¾…åŠ©å†³ç­–</h1>
    <div>
        <button class="btn btn-outline-primary" id="exportBtn">
            <i class="bi bi-download me-1"></i>å¯¼å‡ºæŠ¥å‘Š
        </button>
    </div>
</div>

<!-- å…³é”®æŒ‡æ ‡å¡ç‰‡ -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start border-primary border-4">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-1">å­¦ç”Ÿæ€»æ•°</h6>
                        <h4 class="mb-0">{{ total_students }}</h4>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="bi bi-people-fill text-primary fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start border-success border-4">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-1">è¯¾ç¨‹æ€»æ•°</h6>
                        <h4 class="mb-0">{{ total_courses }}</h4>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="bi bi-journal-bookmark-fill text-success fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start border-warning border-4">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-1">å¹³å‡å‡ºå‹¤ç‡</h6>
                        <h4 class="mb-0">
                            {% if attendance_summary %}
                                {% set total_present = attendance_summary|sum(attribute='present_count') %}
                                {% set total_records = attendance_summary|sum(attribute='present_count') + attendance_summary|sum(attribute='absent_count') + attendance_summary|sum(attribute='leave_count') %}
                                {% if total_records > 0 %}
                                    {{ "%.1f"|format(total_present / total_records * 100) }}%
                                {% else %}
                                    0%
                                {% endif %}
                            {% else %}
                                0%
                            {% endif %}
                        </h4>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="bi bi-calendar-check-fill text-warning fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start border-info border-4">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-1">å¥–åŠ±/å¤„åˆ†æ¯”</h6>
                        <h4 class="mb-0">
                            {% set reward_count = rp_summary|selectattr("0", "equalto", "reward")|map(attribute="1")|first|default(0) %}
                            {% set punishment_count = rp_summary|selectattr("0", "equalto", "punishment")|map(attribute="1")|first|default(0) %}
                            {% set total = reward_count + punishment_count %}
                            {% if total > 0 %}
                                {{ "%.1f"|format(reward_count / total * 100) }}%
                            {% else %}
                                0%
                            {% endif %}
                        </h4>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="bi bi-award-fill text-info fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- å­¦ç”Ÿæ€§åˆ«åˆ†å¸ƒ -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">ğŸ‘¥ å­¦ç”Ÿæ€§åˆ«åˆ†å¸ƒ</h5>
                <span class="badge bg-primary">{{ total_students }} äºº</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div id="genderChart" style="height: 200px;"></div>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            {% for gender, count in students_by_gender %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <span class="gender-dot me-2" style="background-color: {{ ['#4e73df', '#1cc88a', '#36b9cc'][loop.index0] }}"></span>
                                        {{ gender }}
                                    </div>
                                    <div>
                                        <span class="badge bg-primary rounded-pill me-2">{{ count }}</span>
                                        <span class="text-muted small">
                                            {% if total_students > 0 %}
                                                {{ "%.1f"|format(count / total_students * 100) }}%
                                            {% else %}
                                                0%
                                            {% endif %}
                                        </span>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯¾ç¨‹æˆç»©æ¦‚è§ˆ -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">ğŸ“Š è¯¾ç¨‹æˆç»©æ¦‚è§ˆ</h5>
                <span class="badge bg-success">{{ total_courses }} é—¨è¯¾ç¨‹</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>è¯¾ç¨‹åç§°</th>
                                <th>è€ƒè¯•å‡åˆ†</th>
                                <th>è¡¨ç°å‡åˆ†</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for score in avg_scores %}
                                <tr>
                                    <td>{{ score.course_name }}</td>
                                    <td>
                                        {% if score.avg_exam_score is not none %}
                                            {% set exam_score = score.avg_exam_score | float %}
                                            <span class="badge bg-{{ 'success' if exam_score >= 80 else 'warning' if exam_score >= 60 else 'danger' }}">
                                                {{ "%.1f"|format(exam_score) }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if score.avg_performance_score is not none %}
                                            {% set perf_score = score.avg_performance_score | float %}
                                            <span class="badge bg-{{ 'success' if perf_score >= 80 else 'warning' if perf_score >= 60 else 'danger' }}">
                                                {{ "%.1f"|format(perf_score) }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if score.avg_exam_score is not none and score.avg_performance_score is not none %}
                                            {% set exam_score = score.avg_exam_score | float %}
                                            {% set perf_score = score.avg_performance_score | float %}
                                            {% if exam_score >= 80 and perf_score >= 80 %}
                                                <span class="badge bg-success">ä¼˜ç§€</span>
                                            {% elif exam_score >= 60 and perf_score >= 60 %}
                                                <span class="badge bg-warning text-dark">è‰¯å¥½</span>
                                            {% else %}
                                                <span class="badge bg-danger">éœ€å…³æ³¨</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">æ•°æ®ä¸å…¨</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">æš‚æ— è¯¾ç¨‹æˆç»©æ•°æ®</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- è¿‘7å¤©è€ƒå‹¤æ¦‚è§ˆ -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">ğŸ“… è¿‘7å¤©è€ƒå‹¤æ¦‚è§ˆ</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary active" data-period="7">7å¤©</button>
                    <button type="button" class="btn btn-outline-primary" data-period="30">30å¤©</button>
                </div>
            </div>
            <div class="card-body">
                <div id="attendanceChart" style="height: 250px;"></div>
                <div class="mt-3">
                    <ul class="list-group list-group-flush">
                        {% for rec in attendance_summary %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ rec.date }}</strong>
                                    <div class="small text-muted">{{ rec.weekday }}</div>
                                </div>
                                <div>
                                    <span class="badge bg-success me-1">å‡ºå‹¤: {{ rec.present_count }}</span>
                                    <span class="badge bg-danger me-1">ç¼ºå‹¤: {{ rec.absent_count }}</span>
                                    <span class="badge bg-warning text-dark">è¯·å‡: {{ rec.leave_count }}</span>
                                </div>
                            </li>
                        {% else %}
                            <li class="list-group-item text-center text-muted py-4">æš‚æ— è€ƒå‹¤æ•°æ®</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- å¥–åŠ±ä¸å¤„åˆ†ç»Ÿè®¡ -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">ğŸ† å¥–åŠ±ä¸å¤„åˆ†ç»Ÿè®¡</h5>
                <span class="badge bg-info">
                    {% set total_rp = rp_summary|sum(attribute="1") %}
                    {{ total_rp }} æ¡è®°å½•
                </span>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6 text-center">
                        <div id="rewardChart" style="height: 120px;"></div>
                        <h5 class="mt-2 text-success">å¥–åŠ±</h5>
                        <h3>
                            {% set reward_count = rp_summary|selectattr("0", "equalto", "reward")|map(attribute="1")|first|default(0) %}
                            {{ reward_count }}
                        </h3>
                    </div>
                    <div class="col-md-6 text-center">
                        <div id="punishmentChart" style="height: 120px;"></div>
                        <h5 class="mt-2 text-danger">å¤„åˆ†</h5>
                        <h3>
                            {% set punishment_count = rp_summary|selectattr("0", "equalto", "punishment")|map(attribute="1")|first|default(0) %}
                            {{ punishment_count }}
                        </h3>
                    </div>
                </div>
                <div class="progress mb-3" style="height: 20px;">
                    {% set total = reward_count + punishment_count %}
                    {% if total > 0 %}
                        <div class="progress-bar bg-success" style="width: {{ reward_count / total * 100 }}%">
                            {{ "%.1f"|format(reward_count / total * 100) }}%
                        </div>
                        <div class="progress-bar bg-danger" style="width: {{ punishment_count / total * 100 }}%">
                            {{ "%.1f"|format(punishment_count / total * 100) }}%
                        </div>
                    {% endif %}
                </div>
                <div class="alert alert-light border" role="alert">
                    <small class="text-muted">
                        <strong>åˆ†ææç¤º:</strong> 
                        {% if total > 0 %}
                            {% if reward_count / total > 0.7 %}
                                å¥–åŠ±æ¯”ä¾‹è¾ƒé«˜ï¼Œè¯´æ˜å­¦ç”Ÿè¡¨ç°è‰¯å¥½ï¼Œå¯è€ƒè™‘å¢åŠ æ¿€åŠ±æªæ–½ã€‚
                            {% elif punishment_count / total > 0.3 %}
                                å¤„åˆ†æ¯”ä¾‹åé«˜ï¼Œå»ºè®®å…³æ³¨å­¦ç”Ÿè¡Œä¸ºç®¡ç†ï¼ŒåŠ å¼ºæ­£é¢å¼•å¯¼ã€‚
                            {% else %}
                                å¥–æƒ©æ¯”ä¾‹ç›¸å¯¹å¹³è¡¡ï¼Œç»§ç»­ä¿æŒç°æœ‰ç®¡ç†ç­–ç•¥ã€‚
                            {% endif %}
                        {% else %}
                            æš‚æ— å¥–æƒ©è®°å½•ï¼Œå»ºè®®å»ºç«‹å®Œå–„çš„å¥–æƒ©æœºåˆ¶ã€‚
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è¾…åŠ©å†³ç­–æç¤º -->
<div class="card mt-4 border-0 bg-light">
    <div class="card-body">
        <h5 class="card-title">ğŸ’¡ è¾…åŠ©å†³ç­–æç¤º</h5>
        <div class="row">
            <div class="col-md-6">
                <div class="d-flex mb-3">
                    <div class="flex-shrink-0">
                        <i class="bi bi-people-fill text-primary fs-4"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6>å­¦ç”Ÿæ¦‚è§ˆ</h6>
                        <p class="mb-0 text-muted small">äº†è§£å­¦ç”Ÿç¾¤ä½“ç»“æ„ï¼Œä¾‹å¦‚ç”·å¥³æ¯”ä¾‹ï¼Œä¸ºæ‹›ç”Ÿå’Œèµ„æºåˆ†é…æä¾›ä¾æ®ã€‚</p>
                    </div>
                </div>
                <div class="d-flex mb-3">
                    <div class="flex-shrink-0">
                        <i class="bi bi-journal-bookmark-fill text-success fs-4"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6>è¯¾ç¨‹æˆç»©</h6>
                        <p class="mb-0 text-muted small">è¯†åˆ«å“ªäº›è¯¾ç¨‹å­¦ç”Ÿæ™®éè¡¨ç°è‰¯å¥½æˆ–ä¸ä½³ï¼Œä»¥ä¾¿è°ƒæ•´æ•™å­¦æ–¹æ³•æˆ–è¯¾ç¨‹å†…å®¹ã€‚</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex mb-3">
                    <div class="flex-shrink-0">
                        <i class="bi bi-calendar-check-fill text-warning fs-4"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6>è€ƒå‹¤æ¦‚è§ˆ</h6>
                        <p class="mb-0 text-muted small">å¿«é€Ÿå‘ç°ç‰¹å®šæ—¥æœŸæˆ–æ—¶æ®µçš„ç¼ºå‹¤å¼‚å¸¸ï¼ŒåŠæ—¶ä»‹å…¥å¤„ç†ã€‚</p>
                    </div>
                </div>
                <div class="d-flex mb-3">
                    <div class="flex-shrink-0">
                        <i class="bi bi-award-fill text-info fs-4"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6>å¥–æƒ©ç»Ÿè®¡</h6>
                        <p class="mb-0 text-muted small">è¯„ä¼°å­¦æ ¡çš„å¥–æƒ©æœºåˆ¶æ•ˆæœï¼Œå…³æ³¨å­¦ç”Ÿè¡Œä¸ºè¶‹åŠ¿ï¼Œè¿›è¡Œé’ˆå¯¹æ€§æ•™è‚²ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-3 p-3 bg-white rounded">
            <p class="mb-0 small text-muted">
                <strong>è¿›é˜¶å»ºè®®:</strong> æ›´é«˜çº§çš„å†³ç­–æ”¯æŒå¯èƒ½éœ€è¦ç»“åˆæ›´å¤šç»´åº¦çš„æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œå­¦ç”Ÿå®¶åº­èƒŒæ™¯ã€æ•™å¸ˆè¯„ä¼°ç­‰ï¼‰å’Œæ›´å¤æ‚çš„åˆ†æå·¥å…·ã€‚
            </p>
        </div>
    </div>
</div>

<!-- å›¾è¡¨åº“ -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
    .gender-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    
    .card {
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        border: 1px solid #e3e6f0;
    }
    
    .card-header {
        background-color: #f8f9fc;
        border-bottom: 1px solid #e3e6f0;
    }
    
    .progress {
        border-radius: 10px;
    }
    
    .progress-bar {
        border-radius: 10px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // å­¦ç”Ÿæ€§åˆ«åˆ†å¸ƒé¥¼å›¾
        const genderData = [
            {% for gender, count in students_by_gender %}
                { name: "{{ gender }}", value: {{ count }} },
            {% endfor %}
        ];
        
        const genderChart = new ApexCharts(document.querySelector("#genderChart"), {
            series: genderData.map(item => item.value),
            chart: {
                type: 'pie',
                height: 200
            },
            labels: genderData.map(item => item.name),
            colors: ['#4e73df', '#1cc88a', '#36b9cc'],
            legend: {
                show: false
            },
            dataLabels: {
                enabled: false
            }
        });
        genderChart.render();
        
        // è€ƒå‹¤å›¾è¡¨
        const attendanceDates = [
            {% for rec in attendance_summary %}
                "{{ rec.date }}",
            {% endfor %}
        ];
        
        const presentData = [
            {% for rec in attendance_summary %}
                {{ rec.present_count }},
            {% endfor %}
        ];
        
        const absentData = [
            {% for rec in attendance_summary %}
                {{ rec.absent_count }},
            {% endfor %}
        ];
        
        const leaveData = [
            {% for rec in attendance_summary %}
                {{ rec.leave_count }},
            {% endfor %}
        ];
        
        const attendanceChart = new ApexCharts(document.querySelector("#attendanceChart"), {
            series: [
                { name: 'å‡ºå‹¤', data: presentData },
                { name: 'ç¼ºå‹¤', data: absentData },
                { name: 'è¯·å‡', data: leaveData }
            ],
            chart: {
                type: 'bar',
                height: 250,
                stacked: true
            },
            plotOptions: {
                bar: {
                    horizontal: false,
                    columnWidth: '55%',
                }
            },
            colors: ['#1cc88a', '#e74a3b', '#f6c23e'],
            xaxis: {
                categories: attendanceDates
            },
            legend: {
                position: 'top'
            }
        });
        attendanceChart.render();
        
        // å¥–åŠ±ä¸å¤„åˆ†å›¾è¡¨
        {% set reward_count = rp_summary|selectattr("0", "equalto", "reward")|map(attribute="1")|first|default(0) %}
        {% set punishment_count = rp_summary|selectattr("0", "equalto", "punishment")|map(attribute="1")|first|default(0) %}
        
        const rewardChart = new ApexCharts(document.querySelector("#rewardChart"), {
            series: [{{ reward_count }}],
            chart: {
                type: 'radialBar',
                height: 120
            },
            plotOptions: {
                radialBar: {
                    hollow: {
                        size: '60%',
                    },
                    dataLabels: {
                        show: true,
                        name: {
                            show: false
                        },
                        value: {
                            fontSize: '20px',
                            fontWeight: 'bold',
                            offsetY: 5,
                            show: true
                        }
                    }
                }
            },
            colors: ['#1cc88a'],
            labels: ['å¥–åŠ±']
        });
        rewardChart.render();
        
        const punishmentChart = new ApexCharts(document.querySelector("#punishmentChart"), {
            series: [{{ punishment_count }}],
            chart: {
                type: 'radialBar',
                height: 120
            },
            plotOptions: {
                radialBar: {
                    hollow: {
                        size: '60%',
                    },
                    dataLabels: {
                        show: true,
                        name: {
                            show: false
                        },
                        value: {
                            fontSize: '20px',
                            fontWeight: 'bold',
                            offsetY: 5,
                            show: true
                        }
                    }
                }
            },
            colors: ['#e74a3b'],
            labels: ['å¤„åˆ†']
        });
        punishmentChart.render();
        
        // æ—¶é—´å‘¨æœŸåˆ‡æ¢
        document.querySelectorAll('[data-period]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                // è¿™é‡Œå¯ä»¥æ·»åŠ åŠ è½½ä¸åŒå‘¨æœŸæ•°æ®çš„é€»è¾‘
            });
        });
        
        // å¯¼å‡ºæŠ¥å‘ŠåŠŸèƒ½
        document.getElementById('exportBtn').addEventListener('click', function() {
            alert('å¯¼å‡ºåŠŸèƒ½å°†åœ¨å®é™…ç³»ç»Ÿä¸­å®ç°ï¼Œè¿™é‡Œä»…ä½œæ¼”ç¤ºã€‚');
        });
    });
</script>
{% endblock %}