{% extends 'layout.html' %}

{% block title %}统计分析{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">统计分析与辅助决策</h1>
    
    <!-- 顶部概览卡片 -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                学生总数
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {% if total_students is not none %}{{ total_students }}{% else %}0{% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-graduate fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                课程总数
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {% if total_courses is not none %}{{ total_courses }}{% else %}0{% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-book fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                平均出勤率
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="attendanceRateDisplay">
                                <!-- 这里将通过JavaScript计算显示 -->
                                计算中...
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clipboard-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                奖励比例
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="rewardRatioDisplay">
                                <!-- 这里将通过JavaScript计算显示 -->
                                计算中...
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-award fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 主要统计内容 -->
    <div class="row">
        <!-- 学生概览 -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">学生概览</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="font-weight-bold">性别分布</h6>
                            <div class="mt-3">
                                {% if students_by_gender and students_by_gender|length > 0 %}
                                    {% for item in students_by_gender %}
                                        <div class="mb-2 d-flex justify-content-between">
                                            <span>
                                                {% if item.gender == 'male' %}
                                                    男
                                                {% elif item.gender == 'female' %}
                                                    女
                                                {% else %}
                                                    {{ item.gender }}
                                                {% endif %}
                                            </span>
                                            <span class="font-weight-bold">{{ item.count }}</span>
                                        </div>
                                        <div class="progress mb-3" style="height: 10px;">
                                            {% set total_students_int = (total_students|default(0)|int) %}
                                            {% set count_int = (item.count|default(0)|int) %}
                                            {% set percentage = (count_int / total_students_int * 100) if total_students_int > 0 else 0 %}
                                            <div class="progress-bar bg-primary" role="progressbar" 
                                                 style="width: {{ percentage }}%" 
                                                 aria-valuenow="{{ percentage }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">暂无性别分布数据</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
                                <canvas id="genderChart" width="200" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 课程成绩概览 -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-success">课程成绩概览</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="scoreTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>课程名称</th>
                                    <th>考试平均分</th>
                                    <th>表现平均分</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if avg_scores and avg_scores|length > 0 %}
                                    {% for score in avg_scores %}
                                    <tr>
                                        <td>{{ score.course_name }}</td>
                                        <td>
                                            {% if score.avg_exam_score is not none and score.avg_exam_score != 'N/A' %}
                                                {% if score.avg_exam_score is number %}
                                                    <span class="font-weight-bold">{{ "%.2f"|format(score.avg_exam_score) }}</span>
                                                {% else %}
                                                    <span class="font-weight-bold">{{ score.avg_exam_score }}</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if score.avg_performance_score is not none and score.avg_performance_score != 'N/A' %}
                                                {% if score.avg_performance_score is number %}
                                                    <span class="font-weight-bold">{{ "%.2f"|format(score.avg_performance_score) }}</span>
                                                {% else %}
                                                    <span class="font-weight-bold">{{ score.avg_performance_score }}</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">暂无课程成绩数据</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- 近7天考勤概览 -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-info">近7天考勤概览</h6>
                </div>
                <div class="card-body">
                    {% if attendance_summary and attendance_summary|length > 0 %}
                    <div class="chart-area">
                        <canvas id="attendanceChart" width="100%" height="40"></canvas>
                    </div>
                    <div class="mt-3">
                        {% for rec in attendance_summary %}
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span class="font-weight-bold">{{ rec.date }}</span>
                                <div>
                                    <span class="badge badge-success mr-1">出勤: {{ rec.present_count|default(0) }}</span>
                                    <span class="badge badge-danger mr-1">缺勤: {{ rec.absent_count|default(0) }}</span>
                                    <span class="badge badge-warning text-dark">请假: {{ rec.leave_count|default(0) }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-center text-muted">暂无近7天考勤数据</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 奖励与处分统计 -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-warning">奖励与处分统计</h6>
                </div>
                <div class="card-body">
                    {% if rp_summary and rp_summary|length > 0 %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="chart-area">
                                <canvas id="rpChart" style="width: 100%; height: 200px;"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mt-4">
                                {% for item in rp_summary %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>
                                            {% if item.type == 'reward' or item.type == '奖励' %}
                                                <i class="fas fa-award text-success mr-2"></i>奖励
                                            {% elif item.type == 'punishment' or item.type == '处分' %}
                                                <i class="fas fa-exclamation-triangle text-danger mr-2"></i>处分
                                            {% else %}
                                                <i class="fas fa-question-circle text-secondary mr-2"></i>{{ item.type }}
                                            {% endif %}
                                        </span>
                                        <span class="font-weight-bold">{{ item.count|default(0) }}</span>
                                    </div>
                                    <div class="progress mt-1" style="height: 8px;">
                                        {% set total_rp = 0 %}
                                        {% for rp_item in rp_summary %}
                                            {% set total_rp = total_rp + (rp_item.count|default(0)|int) %}
                                        {% endfor %}
                                        {% set percentage = ((item.count|default(0)|int) / total_rp * 100) if total_rp > 0 else 0 %}
                                        <div class="progress-bar 
                                            {% if item.type == 'reward' or item.type == '奖励' %}bg-success
                                            {% elif item.type == 'punishment' or item.type == '处分' %}bg-danger
                                            {% else %}bg-secondary{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ percentage }}%" 
                                             aria-valuenow="{{ percentage }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-center text-muted">暂无奖励或处分记录</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- 辅助决策提示 -->
    <div class="card shadow mt-4">
        <div class="card-header py-3 bg-info text-white">
            <h6 class="m-0 font-weight-bold">辅助决策提示</h6>
        </div>
        <div class="card-body">
            <p>通过这些统计数据，您可以：</p>
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-left-primary shadow-none mb-3">
                        <div class="card-body">
                            <h6 class="font-weight-bold text-primary">学生概览</h6>
                            <p class="mb-0">了解学生群体结构，例如男女比例，为招生和资源分配提供依据。</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-left-success shadow-none mb-3">
                        <div class="card-body">
                            <h6 class="font-weight-bold text-success">课程成绩</h6>
                            <p class="mb-0">识别哪些课程学生普遍表现良好或不佳，以便调整教学方法或课程内容。</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-left-info shadow-none mb-3">
                        <div class="card-body">
                            <h6 class="font-weight-bold text-info">考勤概览</h6>
                            <p class="mb-0">快速发现特定日期或时段的缺勤异常，及时介入处理。</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-left-warning shadow-none mb-3">
                        <div class="card-body">
                            <h6 class="font-weight-bold text-warning">奖惩统计</h6>
                            <p class="mb-0">评估学校的奖惩机制效果，关注学生行为趋势，进行针对性教育。</p>
                        </div>
                    </div>
                </div>
            </div>
            <p class="mt-3 mb-0"><strong>注意：</strong>更高级的决策支持可能需要结合更多维度的数据（例如，学生家庭背景、教师评估等）和更复杂的分析工具。</p>
        </div>
    </div>
</div>

<!-- 引入Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 计算并显示平均出勤率
    function calculateAttendanceRate() {
        const attendanceData = [
            {% if attendance_summary %}
                {% for rec in attendance_summary %}
                {
                    date: '{{ rec.date }}',
                    present: {{ rec.present_count|default(0)|int }},
                    absent: {{ rec.absent_count|default(0)|int }},
                    leave: {{ rec.leave_count|default(0)|int }}
                },
                {% endfor %}
            {% endif %}
        ];
        
        let totalPresent = 0;
        let totalStudents = 0;
        
        attendanceData.forEach(rec => {
            const dayTotal = rec.present + rec.absent + rec.leave;
            if (dayTotal > 0) {
                totalPresent += rec.present;
                totalStudents += dayTotal;
            }
        });
        
        const attendanceRate = totalStudents > 0 ? (totalPresent / totalStudents * 100) : 0;
        document.getElementById('attendanceRateDisplay').textContent = attendanceRate.toFixed(1) + '%';
    }
    
    // 计算并显示奖励比例
    function calculateRewardRatio() {
        const rpData = [
            {% if rp_summary %}
                {% for item in rp_summary %}
                {
                    type: '{{ item.type }}',
                    count: {{ item.count|default(0)|int }}
                },
                {% endfor %}
            {% endif %}
        ];
        
        let rewardCount = 0;
        let punishmentCount = 0;
        
        rpData.forEach(item => {
            if (item.type === 'reward' || item.type === '奖励') {
                rewardCount += item.count;
            } else if (item.type === 'punishment' || item.type === '处分') {
                punishmentCount += item.count;
            }
        });
        
        const total = rewardCount + punishmentCount;
        const rewardRatio = total > 0 ? (rewardCount / total * 100) : 0;
        document.getElementById('rewardRatioDisplay').textContent = rewardRatio.toFixed(1) + '%';
    }
    
    // 初始化计算
    calculateAttendanceRate();
    calculateRewardRatio();
    
    // 性别分布饼图 - 修复版本
    const genderCtx = document.getElementById('genderChart');
    if (genderCtx) {
        // 准备数据
        const genderData = {
            labels: [],
            values: []
        };
        
        {% if students_by_gender and students_by_gender|length > 0 %}
            {% for item in students_by_gender %}
                genderData.labels.push('{{ "男" if item.gender == "male" else "女" if item.gender == "female" else item.gender }}');
                genderData.values.push({{ item.count|default(0)|int }});
            {% endfor %}
        {% endif %}
        
        if (genderData.values.length > 0 && genderData.values.some(val => val > 0)) {
            // 创建饼图
            const genderChart = new Chart(genderCtx, {
                type: 'pie',
                data: {
                    labels: genderData.labels,
                    datasets: [{
                        data: genderData.values,
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                        hoverBackgroundColor: ['#2e59d9', '#17a673', '#2c9faf', '#dda20a', '#be2617'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value}人 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            // 如果没有数据，显示提示
            genderCtx.style.display = 'none';
            const container = genderCtx.parentElement;
            const message = document.createElement('p');
            message.className = 'text-muted text-center';
            message.textContent = '暂无性别分布数据';
            container.appendChild(message);
        }
    }
    
    // 考勤图表
    const attendanceCtx = document.getElementById('attendanceChart');
    if (attendanceCtx && {{ attendance_summary|length|default(0) }} > 0) {
        const attendanceData = [
            {% for rec in attendance_summary %}
            {
                date: '{{ rec.date }}',
                present: {{ rec.present_count|default(0)|int }},
                absent: {{ rec.absent_count|default(0)|int }},
                leave: {{ rec.leave_count|default(0)|int }}
            },
            {% endfor %}
        ];
        
        // 反转数组，使日期从早到晚排列
        attendanceData.reverse();
        
        const attendanceChart = new Chart(attendanceCtx, {
            type: 'line',
            data: {
                labels: attendanceData.map(item => item.date),
                datasets: [
                    {
                        label: "出勤",
                        lineTension: 0.3,
                        backgroundColor: "rgba(78, 115, 223, 0.05)",
                        borderColor: "rgba(78, 115, 223, 1)",
                        pointRadius: 3,
                        pointBackgroundColor: "rgba(78, 115, 223, 1)",
                        pointBorderColor: "rgba(78, 115, 223, 1)",
                        pointHoverRadius: 3,
                        pointHoverBackgroundColor: "rgba(78, 115, 223, 1)",
                        pointHoverBorderColor: "rgba(78, 115, 223, 1)",
                        pointHitRadius: 10,
                        pointBorderWidth: 2,
                        data: attendanceData.map(item => item.present),
                    },
                    {
                        label: "缺勤",
                        lineTension: 0.3,
                        backgroundColor: "rgba(231, 74, 59, 0.05)",
                        borderColor: "rgba(231, 74, 59, 1)",
                        pointRadius: 3,
                        pointBackgroundColor: "rgba(231, 74, 59, 1)",
                        pointBorderColor: "rgba(231, 74, 59, 1)",
                        pointHoverRadius: 3,
                        pointHoverBackgroundColor: "rgba(231, 74, 59, 1)",
                        pointHoverBorderColor: "rgba(231, 74, 59, 1)",
                        pointHitRadius: 10,
                        pointBorderWidth: 2,
                        data: attendanceData.map(item => item.absent),
                    },
                    {
                        label: "请假",
                        lineTension: 0.3,
                        backgroundColor: "rgba(246, 194, 62, 0.05)",
                        borderColor: "rgba(246, 194, 62, 1)",
                        pointRadius: 3,
                        pointBackgroundColor: "rgba(246, 194, 62, 1)",
                        pointBorderColor: "rgba(246, 194, 62, 1)",
                        pointHoverRadius: 3,
                        pointHoverBackgroundColor: "rgba(246, 194, 62, 1)",
                        pointHoverBorderColor: "rgba(246, 194, 62, 1)",
                        pointHitRadius: 10,
                        pointBorderWidth: 2,
                        data: attendanceData.map(item => item.leave),
                    }
                ],
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
    
    // 奖励与处分图表
    const rpCtx = document.getElementById('rpChart');
    if (rpCtx && {{ rp_summary|length|default(0) }} > 0) {
        let rewardCount = 0;
        let punishmentCount = 0;
        
        {% for item in rp_summary %}
            {% if item.type == 'reward' or item.type == '奖励' %}
                rewardCount = {{ item.count|default(0)|int }};
            {% elif item.type == 'punishment' or item.type == '处分' %}
                punishmentCount = {{ item.count|default(0)|int }};
            {% endif %}
        {% endfor %}
        
        if (rewardCount > 0 || punishmentCount > 0) {
            const rpChart = new Chart(rpCtx, {
                type: 'doughnut',
                data: {
                    labels: ['奖励', '处分'],
                    datasets: [{
                        data: [rewardCount, punishmentCount],
                        backgroundColor: ['#1cc88a', '#e74a3b'],
                        hoverBackgroundColor: ['#17a673', '#be2617'],
                        hoverBorderColor: "rgba(234, 236, 244, 1)",
                    }],
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }
    }
});
</script>

<style>
.card {
    border: none;
    border-radius: 0.35rem;
}

.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}

.border-left-info {
    border-left: 0.25rem solid #36b9cc !important;
}

.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}

.shadow {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
}

.text-xs {
    font-size: 0.7rem;
}

.text-gray-800 {
    color: #5a5c69 !important;
}

.text-gray-300 {
    color: #dddfeb !important;
}

.chart-area {
    position: relative;
    height: 10rem;
    width: 100%;
}

@media (min-width: 768px) {
    .chart-area {
        height: 15rem;
    }
}

.badge {
    font-size: 0.75rem;
}

#rpChart {
    max-height: 200px;
}

/* 修复饼图容器样式 */
#genderChart {
    display: block;
    max-width: 100%;
    max-height: 100%;
}
</style>
{% endblock %}